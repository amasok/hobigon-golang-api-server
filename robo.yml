variables:
  work_dir: ~/workspaces/Go/src/github.com/yyh-gl/hobigon-golang-api-server
  git:
    commit: $(git rev-parse HEAD)
    branch: $(git rev-parse --abbrev-ref HEAD)

api-build-local:
  summary: APIサーバをローカルかつLinux用にビルド
  command: |
    robo wire-api
    GO111MODULE=on GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-X main.COMMIT={{.git.commit}} -X main.BRANCH={{.git.branch}}" -o ./docker/api/bin/api-server ./cmd/api/main.go ./cmd/api/wire_gen.go
    rm -f ./cmd/api/wire_gen.go

api-build-prod:
  summary: APIサーバをProductionかつLinux用にビルド
  command: |
    robo wire-api
    GO111MODULE=on GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-X main.COMMIT={{.git.commit}} -X main.BRANCH={{.git.branch}}" -o ./cmd/api/bin/api-server ./cmd/api/main.go ./cmd/api/wire_gen.go
    rm -f ./cmd/api/wire_gen.go

cli-build-local:
  summary: CLIをローカルかつMac用にビルド
  command: |
    robo wire-cli
    GO111MODULE=on GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-X main.COMMIT={{.git.commit}} -X main.BRANCH={{.git.branch}}" -o ./docker/cli/bin/hobi ./cmd/cli/main.go ./cmd/cli/wire_gen.go
    rm -f ./cmd/cli/wire_gen.go

cli-build-prod:
  summary: CLIをProductionかつLinux用にビルド
  command: |
    robo wire-cli
    GO111MODULE=on GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-X main.COMMIT={{.git.commit}} -X main.BRANCH={{.git.branch}}" -o ./cmd/cli/bin/hobi ./cmd/cli/main.go ./cmd/cli/wire_gen.go
    rm -f ./cmd/cli/wire_gen.go

all-build-local:
  summary: APIサーバおよびCLIをローカルかつLinux用にビルド
  command: |
    robo api-build-local
    robo cli-build-local

all-build-prod:
  summary: APIサーバおよびCLIをProductionかつLinux用にビルド
  command: |
    robo api-build-prod
    robo cli-build-prod

deploy:
  summary: ProductionかつLinux用にビルドしてからデプロイ（masterにPUSH）
  command: |
    robo all-build-prod
    git add ./cmd/api/bin/api-server ./cmd/cli/bin/hobi
    git commit -m "[`date +'%Y/%m/%d %H:%M:%S'`] 最新版デプロイ"
    git push origin master

wire-api:
  summary: APIサーバ用 wire_gen 生成
  command: |
    cd ./cmd/api
    wire
    cd -

wire-cli:
  summary: CLI用 wire_gen 生成
  command: |
    cd ./cmd/cli
    wire
    cd -

lint:
  summary: Docker経由でLint実行
  command: |
    docker-compose exec -T app golangci-lint run ./...

test:
  summary: Docker経由でテスト実行
  command: |
    APP_ENV=test go test ./...
